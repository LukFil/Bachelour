(function(){$.widget("ncbi.granthubsearchresults",{options:{items:[],open:null},_create:function(){this._build(),this.first_refresh=!0,this.refresh()},_build:function(){this._addClass("ghs-result")},_setOptions:function(t){this._super(t),this.refresh()},refresh:function(){var t,e,s,n,i;if(0===this.options.items.length)return this._empty(),void this.element.hide();for(s=$("<div></div>"),i=this.options.items,t=0,n=i.length;t<n;t++)e=i[t],s.append($("<fieldset></fieldset>").granthubsearchresultitem({classes:this.options.classes,person:e.person,awards:e.awards,authority:e.authority}));this._empty(),s.children().appendTo(this.element),this.element.show(),this._trigger("open")},_empty:function(){this.element.find(".ghs-result-item").remove()},some_checked:function(){return this.element.children("fieldset").is(function(t,e){return $(e).granthubsearchresultitem("checked")})},checked_items:function(){var t;return t=[],this.element.children("fieldset").each(function(){var e,s,n,i;if($(this).granthubsearchresultitem("checked"))for(i=$(this).granthubsearchresultitem("checked_awards"),s=0,n=i.length;s<n;s++)e=i[s],t.push({award:e,person:$(this).granthubsearchresultitem("option","person"),authority:$(this).granthubsearchresultitem("option","authority")})}),t}}),$.widget("ncbi.granthubsearchresultitem",{options:{person:{},awards:[],authority:null,change:null},_create:function(){this._build(),this.refresh()},_build:function(){return this.el_person_legend=$("<legend></legend>"),this.el_full_name=$("<span></span>"),this.el_awardee=$("<span></span>"),this.el_awards=$("<div></div>"),this._addClass("ghs-result-item"),this._addClass(this.el_person_legend,"ghs-result-person"),this._addClass(this.el_full_name,"ghs-result-full-name"),this._addClass(this.el_awardee,"ghs-result-awardee"),this._addClass(this.el_awards,"ghs-result-awards"),this.el_person_legend.append(this.el_full_name),this.el_person_legend.append(this.el_awardee),this.element.append(this.el_person_legend),this.element.append(this.el_awards),this.el_full_name.after(" ")},_setOptions:function(t){this._super(t),this.refresh()},refresh:function(){var t,e,s,n,i,r;if(0!==this.options.awards.length){for(this.el_full_name.text(this.options.person.given_names+" "+this.options.person.last_name),t=this.options.awards[0].awardee,void 0!==t?this.el_awardee.text(t.name):this.el_awardee.text("Unknown"),e=$("<div></div"),r=this.options.awards,n=0,i=r.length;n<i;n++)s=r[n],e.append(this._build_award(s));this.el_awards.empty(),e.children().appendTo(this.el_awards)}},_build_award:function(t){var e;return e=$("<div></div>"),e.granthubsearchresultaward({classes:this.options.classes,award:t,change:function(t){return function(e,s){return t.on_change(e,s)}}(this)}),e},on_change:function(t,e){this._trigger("change",t,{award:e,person:this.options.person})},checked:function(){return this.el_awards.children("div").is(function(){return $(this).granthubsearchresultaward("option","checked")})},checked_awards:function(){var t;return t=[],this.el_awards.children("div").each(function(){if($(this).granthubsearchresultaward("option","checked"))return t.push($(this).granthubsearchresultaward("option","award"))}),t}}),$.widget("ncbi.granthubsearchresultaward",{options:{award:null,checked:!1,change:null},_create:function(){var t,e,s,n,i,r,a,h,u;if(t=$('<input type=checkbox name=number value="'+this.options.award.number+'" data-grantid="'+this.options.award.id+'"/>'),this._addClass(t,"ghs-result-checkbox"),t.uniqueId(),s=$('<label for="'+t.attr("id")+'"></label'),i=$("<span>"+this.options.award.number+"</span>"),u=$("<span>"+this.options.award.title+"</span>"),this._addClass(i,"ghs-result-number"),this._addClass(u,"ghs-result-title"),s.append(i),s.append(u),this.options.award.other_awards)for(h=this.options.award.other_awards,e=0,n=h.length;e<n;e++)r=h[e],r.title&&(a=$("<span>"+r.title+"</span>"),this._addClass(a,"ghs-result-other-title"),s.append(a));return this._addClass("ghs-result-award"),i.after(" "),this._addClass(s,"ghs-result-label"),this.element.append(s),this.element.append(t),t.checkboxradio(),t.change(function(t){return function(e){return t.on_change(e)}}(this))},on_change:function(t){this.options.checked=$(t.target).is(":checked"),this._trigger("change",t,{award:this.options.award})}}),$.widget("ncbi.granthubsearchresultscount",{options:{items:[],in_progress:!1},_create:function(){this._build(),this.first_refresh=!0,this.refresh()},_build:function(){return this._addClass("ghs-count")},_setOptions:function(t){this._super(t),this.refresh()},refresh:function(){var t,e,s,n,i,r,a,h;if(this.options.in_progress)this.element.text("Searching...");else if(0===(t=this.options.items.length))!0===this.first_refresh?(this.first_refresh=!1,this.element.text("")):this.element.text("Nothing found");else{for(e=0,h=this.options.items,s=0,i=h.length;s<i;s++)n=h[s],e+=n.awards.length;r=t>1&&"s"||"",a=e>1&&"s"||"",this.element.text("Found "+t+" grantee"+r+", "+e+" grant"+a)}}})}).call(this),function(){$.widget("ncbi.granthubsearch",{version:"0.0.3",options:{number:null,title:null,first_name:null,last_name:null,limit:500,search_endpoint:"https://api.ncbi.nlm.nih.gov/granthub/collapsed/",suggest_endpoint:"https://api.ncbi.nlm.nih.gov/granthub/suggest/number/",authority_codes:"",has_title:!1},_create:function(){this._build(),this.refresh()},_build:function(){this._addClass("ghs-wrapper"),this.number=$('<input placeholder="Grant number or name" role="textbox" type="text" title="Use up and down arrows to choose an item from the autocomplete." aria-haspopup="true" aria-autocomplete="list" />'),this.number.granthubsuggest({classes:this.options.classes,endpoint:this.options.suggest_endpoint,authority_codes:this.options.authority_codes,select:function(t){return function(e,s){return t.options.number=s.item.number,t._delay(t.search)}}(this),response:function(t){return function(e,s){return t._trigger("suggest_done",e,s)}}(this)}),this.options.has_title&&(this.title=$('<input placeholder="Title" type="text" />'),this._addClass(this.title,"ghs-title")),this.first_name=$('<input placeholder="First name" type="text" />'),this._addClass(this.first_name,"ghs-first-name"),this.last_name=$('<input placeholder="Last name" type="text" />'),this._addClass(this.last_name,"ghs-last-name"),this.button_group=$("<div></div>"),this._addClass(this.button_group,"ghs-button-group"),this.search_btn=$("<button>Search</button>").button({classes:{"ui-button":"ghs-search-button"}}).click(function(t){return function(){return t.search()}}(this)),this.clear_btn=$("<button>Clear</button>").button({classes:{"ui-button":"ghs-clear-button"}}).click(function(t){return function(){return t.clear()}}(this)),this.results=$("<div></div>"),this.results.granthubsearchresults({classes:this.options.classes}),this.results_count=$("<div></div>"),this.results_count.granthubsearchresultscount({classes:this.options.classes}),this._click_on_return(this.number,this.search_btn),this.options.has_title&&this._click_on_return(this.title,this.search_btn),this._click_on_return(this.first_name,this.search_btn),this._click_on_return(this.last_name,this.search_btn),this._appendLabel(this.number,"Grant Number"),this.element.append(this.number),this.options.has_title&&(this._appendLabel(this.title,"Grant Title"),this.element.append(this.title)),this._appendLabel(this.first_name,"Grantee First Name"),this.element.append(this.first_name),this._appendLabel(this.last_name,"Grantee Last Name"),this.element.append(this.last_name),this.element.append(this.button_group),this.button_group.append(this.search_btn),this.button_group.append(this.clear_btn),this.element.append(this.results_count),this.element.append(this.results)},_click_on_return:function(t,e){return t.keyup(function(t){if(13===t.keyCode)return e.click()})},_appendLabel:function(t,e){var s;return t.uniqueId(),s=$('<label for="'+t.attr("id")+'"> '+e+" </label>"),s.uniqueId(),t.attr("aria-labelledby",s.attr("id")),this._addClass(s,"ghs-label"),this.element.append(s)},_setOptions:function(t){this._super(t),this.refresh()},refresh:function(){var t;this.options.number!==this.number.val()&&(this.number.val(this.options.number),this.number.granthubsuggest("search")),null!=(t=this.title)&&t.val(this.options.title),this.first_name.val(this.options.first_name),this.last_name.val(this.options.last_name)},_destroy:function(){this.element.empty()},search:function(){var t,e,s,n,i,r;s=this.number.val(),t=this.first_name.val(),e=this.last_name.val(),r=null!=(i=this.title)?i.val():void 0,n={},s&&(n["award.number"]=s),r&&(n["award.title__like"]="*"+r+"*"),t&&(n["person.given_names__like"]=t+"*"),e&&(n["person.last_name"]=e),Object.getOwnPropertyNames(n).length>0?(n.limit=this.options.limit,this.options.authority_codes.length>0&&(n["authority.code__in"]=this.options.authority_codes),this._trigger("search_started",this,n),$.ajax({url:this.options.search_endpoint,dataType:"json",data:n,success:function(t){return function(e){t.results.granthubsearchresults({items:e.body}),t.results_count.granthubsearchresultscount({items:e.body,in_progress:!1}),t._trigger("search_done",t,{items:e.body})}}(this)}),this.results_count.granthubsearchresultscount({in_progress:!0})):(this.results.granthubsearchresults({items:[]}),this.results_count.granthubsearchresultscount({items:[],in_progress:!1}))},clear:function(){var t;return this.number.val(""),this.first_name.val(""),this.last_name.val(""),null!=(t=this.title)&&t.val(""),this.results.granthubsearchresults({items:[]}),this.results_count.granthubsearchresultscount({items:[],in_progress:!1})},checked_items:function(){return this.results.granthubsearchresults("checked_items")}})}.call(this),function(){$.widget("ncbi.granthubsuggest",{options:{endpoint:"https://api.ncbi.nlm.nih.gov/granthub/suggest/number/",authority_codes:""},_create:function(){this._addClass("ghs-number-input"),this.element.autocomplete({classes:this.options.classes,source:function(t){return function(e,s){var n;n={term:e.term},t.options.authority_codes.length>0&&(n["authority.code__in"]=t.options.authority_codes),$.ajax({url:t.options.endpoint,dataType:"json",data:n,success:function(e){var n;n=t._parse_suggest(e.body),s(n),1===n.length&&n[0].number===t.element.val()&&t._delay(function(){var t;t=this.element.autocomplete("widget"),t.children().click()})}})}}(this),minLength:2,select:function(t){return function(e,s){if(!s.item.final)return t.element.val(s.item.key),t._delay(function(){this.element.autocomplete("search")}),!1;s.item.value=s.item.number,t._trigger("select",e,{item:s.item})}}(this),response:function(t){return function(e,s){return t._trigger("response",e,s.content)}}(this)})},search:function(){this.element.autocomplete("search")},_parse_suggest:function(t){var e;return this._unique_numbers(function(){var s,n,i;for(i=[],s=0,n=t.length;s<n;s++)e=t[s],i.push(this._parse_suggest_item(e));return i}.call(this))},_parse_suggest_item:function(t){var e;return e=""!==t.number,{key:t.label.replace(/(?:\.\.\.|:).*$/,""),value:e&&t.number||t.label,final:e,number:t.number}},_unique_numbers:function(t){var e,s,n,i,r;for(i=[],r={},e=0,n=t.length;e<n;e++)s=t[e],s.final?r.hasOwnProperty(s.number)||(r[s.number]=!0,i.push(s)):i.push(s);return i}})}.call(this);